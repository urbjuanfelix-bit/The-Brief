// ==========================================
// CONFIGURACIÓN DE "EL CRONISTA" - MOTOR 2.5 ANTI-ERRORES
// ==========================================
const CLAVE_SUCIA = "AIzaSyAf2XL_BwDH5CIEn-SW4pieGPJr4MY5NHA"; // <--- PEGA TU CLAVE AQUÍ
const GEMINI_API_KEY = CLAVE_SUCIA.trim(); 
const SHEET_NAME_FUENTES = "FUENTES";
const SHEET_NAME_NOTICIAS = "Noticias";

function actualizarPeriodicoConIA() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const hojaFuentes = ss.getSheetByName(SHEET_NAME_FUENTES);
  const hojaNoticias = ss.getSheetByName(SHEET_NAME_NOTICIAS);
  
  if (!hojaFuentes || !hojaNoticias) {
    Logger.log("Error: No se encuentran las pestañas 'FUENTES' o 'Noticias'");
    return;
  }

  const secciones = ["Política", "Economía", "Ocio", "Deportes", "Tech"];
  const fuentesData = hojaFuentes.getDataRange().getValues();
  
  if (hojaNoticias.getLastRow() > 1) {
    hojaNoticias.getRange(2, 1, hojaNoticias.getLastRow() - 1, 7).clearContent();
  }

  secciones.forEach(seccion => {
    Logger.log(">>> Procesando Sección: " + seccion);
    
    let fuentesSeccion = fuentesData.filter(f => {
      return String(f[0]).trim().toLowerCase() === seccion.toLowerCase();
    });

    let noticiasCrudas = [];
    fuentesSeccion.forEach(f => {
       let items = extraerNoticiasDeRSS(f[1], 4);
       items.forEach(item => {
         noticiasCrudas.push({
           tituloOriginal: item.titulo,
           descripcionOriginal: item.descripcion,
           imagenOriginal: item.imagen,
           medio: f[3], 
           sesgo: f[4]  
         });
       });
    });

    if (noticiasCrudas.length === 0) {
      Logger.log("Aviso: No se encontraron noticias para '" + seccion + "'");
      return;
    }

    try {
      let noticiasEditadas = procesarConGemini25(seccion, noticiasCrudas.slice(0, 10));
      
      if (noticiasEditadas && Array.isArray(noticiasEditadas)) {
        noticiasEditadas.forEach(noticia => {
          let imagenFinal = noticia.imagen_url || "https://images.unsplash.com/photo-1504711434969-e33886168f5c?q=80&w=800";

          hojaNoticias.appendRow([
            new Date(),
            noticia.titulo || "Sin título",
            noticia.antetitulo || "ACTUALIDAD",
            imagenFinal,
            noticia.texto || "Contenido en redacción...",
            seccion === "Ocio" ? "Cultura" : seccion, // Mapeo de Ocio a Cultura
            (noticia.fuente || "Redacción") + " [" + (noticia.sesgo_aplicado || "Neutral") + "]"
          ]);
        });
      }
    } catch (e) {
      Logger.log("Error en " + seccion + ": " + e.message);
    }
  });
  Logger.log("¡Proceso finalizado con éxito!");
}

function extraerNoticiasDeRSS(url, limite) {
  if (!url || !url.startsWith('http')) return [];
  try {
    const res = UrlFetchApp.fetch(url, {muteHttpExceptions: true, timeoutInterval: 15000});
    if (res.getResponseCode() !== 200) return [];
    
    const xml = res.getContentText();
    const doc = XmlService.parse(xml);
    const root = doc.getRootElement();
    const channel = root.getChild("channel");
    
    if (channel) {
      const items = channel.getChildren("item");
      const mediaNS = XmlService.getNamespace("media", "http://search.yahoo.com/mrss/");
      
      return items.slice(0, limite).map(item => {
        let img = "";
        const enclosure = item.getChild("enclosure");
        const mediaContent = item.getChild("content", mediaNS);
        if (enclosure) img = enclosure.getAttribute("url").getValue();
        else if (mediaContent) img = mediaContent.getAttribute("url").getValue();
        
        return {
          titulo: item.getChildText("title") || "",
          descripcion: item.getChildText("description") || "",
          imagen: img
        };
      });
    }
  } catch(e) { Logger.log("Error en RSS (" + url + ")"); }
  return [];
}

function procesarConGemini25(seccion, noticias) {
  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`;
  
  const prompt = `RESPONDE ÚNICAMENTE CON UN ARRAY JSON. 
  Eres el Redactor Jefe de "El Cronista". Redacta 6 noticias para ${seccion}. 
  Usa estos datos: ${JSON.stringify(noticias)}.
  Formato: [{"titulo": "..", "antetitulo": "..", "texto": "..", "fuente": "..", "sesgo_aplicado": "..", "imagen_url": ".."}]
  No incluyas saludos ni explicaciones, solo el JSON.`;

  const payload = {
    "contents": [{ "parts": [{ "text": prompt }] }],
    "generationConfig": { "response_mime_type": "application/json" } // Obliga a Gemini a ser una máquina de datos
  };

  const options = {
    "method": "post",
    "contentType": "application/json",
    "payload": JSON.stringify(payload),
    "muteHttpExceptions": true
  };

  const response = UrlFetchApp.fetch(url, options);
  const text = response.getContentText();
  
  if (response.getResponseCode() !== 200) throw new Error("Fallo API: " + text);

  const resObj = JSON.parse(text);
  if (resObj.candidates && resObj.candidates[0].content) {
    let rawText = resObj.candidates[0].content.parts[0].text;
    
    // EXTRACTOR DE SEGURIDAD: Busca el primer '[' y el último ']' por si la IA habla
    const inicio = rawText.indexOf('[');
    const fin = rawText.lastIndexOf(']') + 1;
    if (inicio !== -1 && fin !== -1) {
        rawText = rawText.substring(inicio, fin);
    }
    
    return JSON.parse(rawText);
  }
  return null;
}